<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:f="http://java.sun.com/jsf/core"
  template="WEB-INF/facelets/layout.xhtml">

<ui:define name="head">

  <script type="text/javascript" src="/static/ckeditor/ckeditor.js"></script>
  <script type="text/javascript">

    var pageId = '#{pageBean.current.id}';

    //<!--
    
    var contentEditor;
    var autosaveTimer = '';
    
    $(function(){
    	contentEditor = CKEDITOR.replace('form:content', {
        	height: 480,
    		filebrowserUploadUrl : '/cms/upload',
            filebrowserBrowseUrl : '/cms/fileBrowser'
        });
        $("#tabs").tabs();
        $("#tabs").bind('tabsselect', tabSelected);       
        $(".datepicker").datepicker({dateFormat:'dd.mm.yy'});
        initJSONRpc();
    });
    
    function onTitleChange() {
        if ($(".form-url").length == 1) {
            var url = $(".form-url").val();
            var title = $(".form-title").val();
            if (url == "") {
                $(".form-url").val(urlFromTitle(title));
            }
        }
    }

    function tabSelected(event, ui) {
        if (ui.index == 1) {
            startAutosave();
        }
        else {
            stopAutosave();
        }            
    }
    
    function startAutosave() {
     	if (pageId != 'null') {
     	    if (autosaveTimer == '') {
     	        autosaveTimer = setInterval(saveContent, AUTOSAVE_TIMEOUT * 1000);
     	    }
        }
    }
    
    function stopAutosave() {
        if (autosaveTimer != '') {
            clearInterval(autosaveTimer);
            autosaveTimer = '';
        }
    }

    function saveContent() {
        var content = $("#ckeditor-form-row iframe").contents().find("body").html();
        jsonrpc.pageService.updateContent(function(r) {
            if (r.result == 'success') {
                var now = new Date();
                infoMessage(r.message + " " + now);
            }
            else {
                errorMessage(r.message);
            }            
        }, pageId, content);        
    }

    function onAutosave() {
        if ($("#autosave:checked").length > 0) {
            startAutosave(); 
        }
        else {
            stopAutosave();
        }
    }
    
    // -->    
  </script>
    
</ui:define>

<ui:define name="title">Page</ui:define>

<ui:define name="body">

<h:form id="form">

<div id="tabs">
<ul>
    <li><a href="#tab-1">Page</a></li>
    <li><a href="#tab-2">Content</a></li>
    <h:panelGroup rendered="#{pageBean.showChildren}">
    <li><a href="#tab-3">Children pages</a></li>
    </h:panelGroup>    
    <li><a href="#tab-4">Comments</a></li>
</ul>

<div id="tab-1">

<div class="form-row">
    <label>Title</label>
    <h:inputText styleClass="form-title" value="#{pageBean.current.title}" size="40" 
        onchange="onTitleChange()"/>
</div>
<div class="form-row">
    <label>Friendly URL &#160;</label>
    <h:panelGroup rendered="#{pageBean.editURL}">    
        <h:outputText value="#{pageBean.current.parentFriendlyURL}/" />
        <h:inputText styleClass="form-url" value="#{pageBean.current.pageFriendlyURL}" size="40"/>
    </h:panelGroup>
    <h:panelGroup rendered="#{!pageBean.editURL}">    
        <h:outputText value="#{pageBean.current.friendlyURL}" />
    </h:panelGroup>
</div>
<div class="form-row">
    <label>Template</label>
    <h:selectOneMenu value="#{pageBean.current.template}">
        <f:selectItems value="#{pageBean.templates}" />
    </h:selectOneMenu>
</div>
<div class="form-row">
    <label>Publication date</label>
    <h:inputText value="#{pageBean.publishDate}" styleClass="datepicker" size="8"/>
</div>
<div class="form-row">
    <label>Enable comments</label>
    <h:selectBooleanCheckbox value="#{pageBean.current.commentsEnabled}" />
</div>

<div class="buttons">
    <h:commandButton value="Save" action="#{pageBean.update}" />
    <h:commandButton value="Preview" action="#{pageBean.preview}" 
        rendered="#{pageBean.edit}"/>
    <h:commandButton value="Cancel" action="#{pageBean.cancelEdit}" />
</div>    

</div>

<div id="tab-2">

<div>
  <input id="autosave" type="checkbox" checked="checked" onchange="onAutosave()"> Autosave</input>
</div>

<div class="form-row" id="ckeditor-form-row">
    <h:inputTextarea id="content" rows="20" cols="80" 
        value="#{pageBean.current.content}" />
</div>

<div class="buttons">
    <h:commandButton value="Save" action="#{pageBean.update}" />
    <h:commandButton value="Preview" action="#{pageBean.preview}" 
        rendered="#{pageBean.edit}"/>
    <h:commandButton value="Cancel" action="#{pageBean.cancelEdit}" />
</div>    

</div>

<h:panelGroup rendered="#{pageBean.showChildren}">
<div id="tab-3">

<h:dataTable value="#{pageBean.children}" var="page" styleClass="form-table">
    <h:column>
        <f:facet name="header"></f:facet>    
        <h:selectBooleanCheckbox value="#{pageBean.selected[page.id]}"/>
    </h:column>
    <h:column>
        <f:facet name="header" >Title</f:facet>    
        <a href="/cms/page/edit/#{page.id}"><h:outputText value="#{page.title}"/></a>
    </h:column>
    <h:column>
        <f:facet name="header" >Friendly URL</f:facet>    
        <h:outputText value="#{page.friendlyURL}"/>
    </h:column>
</h:dataTable>
<div class="buttons">
    <h:commandButton value="Add child page" action="#{pageBean.addChild}" />
    <h:commandButton value="Delete pages" action="#{pageBean.delete}" />
</div>    

</div>
</h:panelGroup>

<div id="tab-4">
<h:dataTable value="#{pageBean.comments}" var="r" styleClass="form-table">
    <h:column>
        <f:facet name="header"></f:facet>    
        <h:selectBooleanCheckbox value="#{pageBean.selectedComments[r.id]}"/>
    </h:column>
    <h:column>
        <f:facet name="header" >Status</f:facet>    
        <h:panelGroup rendered="#{r.disabled}">Disabled</h:panelGroup>
        <h:panelGroup rendered="#{!r.disabled}">Enabled</h:panelGroup>
    </h:column>
    <h:column>
        <f:facet name="header" >Name</f:facet>    
        <h:outputText value="#{r.name}"/>
    </h:column>
    <h:column>
        <f:facet name="header" >Content</f:facet>    
        <h:outputText value="#{r.content}"/>
    </h:column>
</h:dataTable>
<div class="buttons">
    <h:commandButton value="Enable comments" action="#{pageBean.enableComments}" />
    <h:commandButton value="Disable comments" action="#{pageBean.disableComments}" />
    <h:commandButton value="Delete comments" action="#{pageBean.deleteComments}" />
</div>    
</div>

</div>

</h:form>

</ui:define>

</ui:composition>
