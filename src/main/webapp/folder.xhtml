<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:f="http://java.sun.com/jsf/core"
  template="WEB-INF/facelets/layout.xhtml">

<ui:define name="head">

    <script src="/static/js/jquery.form.js" language="javascript"></script>

<script type="text/javascript">

var jsonrpc;
var folderId = '#{folderBean.current.id}';
var files = '';

// <!--

$(function() {
    $("#tabs").tabs();
    $("#file-upload").dialog({ width: 400, autoOpen: false });
    jsonrpc = new JSONRpcClient("/JSON-RPC/");
    loadFiles();
});

$(document).ready(function () {
    $('#upload').ajaxForm(afterUpload);
});

function onUpload() {
    $("#file-upload").dialog("open");
    return false;	
}
function onFileUploadCancel() {
	$("#file-upload").dialog("close");
}

function afterUpload(data) {
    var s = data.split('::');
    var result = s[1];
    var msg = s[2]; 
    if (result == 'success') {
        msg = 'File was successfully uploaded.';
    }
    $("#file-upload").dialog("close");
    $("#afterUpload-dialog .message").text(msg);
    $("#afterUpload-dialog").dialog();
}

function onAfterUploadOk() {
    $("#afterUpload-dialog").dialog("close");
	loadFiles();
}

function loadFiles() {
	files = jsonrpc.fileService.getByFolder(folderId);
    var html = "<table class=\"form-table\">";
	for (i=0; i < files.list.length; i++) {
	    var file = files.list[i];
	    var item = "<tr><td>" + file.filename + "</td><td>" + file.mimeType 
	        + "</td><td>" + file.size + " bytes</td></tr>";
        html += item;
	}
	html += "</table>";
	$("#filesTable").html(html);
}
// -->
</script>

</ui:define>

<ui:define name="title">Folder</ui:define>

<ui:define name="body">

<h:form>

<div id="tabs">
<ul>
    <li><a href="#tab-1">Folder</a></li>
<h:panelGroup rendered="#{folderBean.showFiles}">
    <li><a href="#tab-2">Files</a></li>
</h:panelGroup>
<h:panelGroup rendered="#{folderBean.showChildren}">
    <li><a href="#tab-3">Subfolders</a></li>
</h:panelGroup>
</ul>

<div id="tab-1">

<div class="form-row">
    <label>Title</label>
    <h:inputText value="#{folderBean.current.title}" />
</div>
<div class="form-row">
    <label>Name for URL</label>
    <h:inputText value="#{folderBean.current.name}" />
</div>
<div class="buttons">
    <h:commandButton value="Save" action="#{folderBean.update}" />
    <h:commandButton value="Cancel" action="#{folderBean.cancelEdit}" />
</div>    

</div>

<h:panelGroup rendered="#{folderBean.showFiles}">
<div id="tab-2">
    <div id="filesTable"> </div>
    <div class="buttons">
        <input type="button" onclick="onUpload()" value="Upload file" />
        <h:commandButton value="Delete files" action="#{folderBean.deleteFiles}" />
    </div>
</div>
</h:panelGroup>

<h:panelGroup rendered="#{folderBean.showChildren}">
<div id="tab-3">

<h:dataTable value="#{folderBean.children}" var="r"
    styleClass="form-table">
    <h:column>
        <f:facet name="header"></f:facet>    
        <h:selectBooleanCheckbox value="#{folderBean.selected[r.id]}"/>
    </h:column>
    <h:column>
        <f:facet name="header" >Title</f:facet>    
        <a href="/cms/folder/edit/#{r.id}"><h:outputText value="#{r.title}"/></a>
    </h:column>
    <h:column>
        <f:facet name="header" >Name</f:facet>    
        <h:outputText value="#{r.name}"/>
    </h:column>
</h:dataTable>
<div class="buttons">
    <h:commandButton value="Add child folder" action="#{folderBean.addChild}" />
    <h:commandButton value="Delete folders" action="#{folderBean.delete}" />
</div>    

</div>
</h:panelGroup>

</div>

</h:form>

<div id="file-upload" title="Upload file to folder" style="display:none">
<form id="upload" action="/cms/upload" method="post" enctype="multipart/form-data">
    File upload:
    <input type="hidden" name="fileType" value="resource" />
    <input type="hidden" name="folderId" value="#{folderBean.current.id}" />
    <input type="file" name="uploadFile" />
    <div class="buttons-dlg">
        <input type="submit" value="Send" />
        <input type="button" onclick="onFileUploadCancel()" value="Cancel" />
    </div>
</form>
</div>

<div id="afterUpload-dialog" style="display:none" title="Status window">
    <p class="message"></p>
    <div class="buttons-dlg">
        <input type="button" onclick="onAfterUploadOk()" value="OK" />
    </div>
</div>


</ui:define>

</ui:composition>
