<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:f="http://java.sun.com/jsf/core"
  template="WEB-INF/facelets/layout.xhtml">

<ui:define name="head">

    <script src="/static/js/jquery.form.js" language="javascript"></script>

<script type="text/javascript">

var jsonrpc;
var folderId = '#{folderBean.current.id}';
var files = '';

// <!--

$(document).ready(function () {
    $('#upload').ajaxForm(afterUpload);
});

$(function() {
    $("#tabs").tabs();
    $("#file-upload").dialog({ width: 400, autoOpen: false });
    jsonrpc = new JSONRpcClient(jsonInitCallback, "/JSON-RPC/");
});

function jsonInitCallback(result, e) {
    if (e) {
        errorMessage("Error dusing initializing JSON-RPC." + e);
    }
    else {
        loadFiles();
    }
}

function onUpload() {
    $("#file-upload").dialog("open");
}
function onFileUploadCancel() {
	$("#file-upload").dialog("close");
}

function afterUpload(data) {
    var s = data.split('::');
    var result = s[1];
    var msg = s[2]; 
    if (result == 'success') {
        infoMessage('File was successfully uploaded.');
        loadFiles();
    }
    else {
        errorMessage("Error during uploading file. " + msg);
    }
    $("#file-upload").dialog("close");
}

function loadFiles() {
	jsonrpc.fileService.getByFolder(loadFilesCallback, folderId);
}

function loadFilesCallback(r) {
    files = r
    var html = "<table class=\"form-table\">";
    for (i = 0; i < files.list.length; i++) {
        var file = files.list[i];
        var fileTitle = "<a href=\"/cms/file/edit/" + file.id + "\">" + file.title + "</a>";
        var item = "<tr><td>"
            + "<input type=\"checkbox\" name=\"item" + i + "\" value=\"" + file.id + "\"/></td><td>" 
            + fileTitle + "</td><td>" 
            + file.filename + "</td><td>" 
            + file.mimeType + "</td><td>" 
            + file.size + " bytes</td></tr>";
        html += item;
    }
    html += "</table>";
    $("#filesTable").html(html);
}

function getCheckedFilesIds() {
    var result = [];
    var i = 0;
	$("#form input[type=checkbox]:checked").each(function() {
        result[i++] = this.value;
    });
    return result; 
}

function onDeleteFiles() {
    var ids = javaList(getCheckedFilesIds());
    if (ids.list.length > 0) {
        jsonrpc.fileService.deleteFiles(deleteFilesCallback, ids);
    }
}

function deleteFilesCallback(r) {
    if (r.result == "success") {
        loadFiles();
        infoMessage("Files was successfully deleted.");
    }
    else {
        errorMessage("Error during deleting files. " + r.messsage);
    }
}

function onCreateFile() {
    location.href = "/cms/file/create/" + folderId;
}

function onTitleChange() {
    var url = $(".form-url").val();
    var title = $(".form-title").val();
    if (url == "") {
        $(".form-url").val(urlFromTitle(title));
    }
}

// -->
</script>

</ui:define>

<ui:define name="title">Folder</ui:define>

<ui:define name="body">

<h:form id="form">

<div id="tabs">
<ul>
    <li><a href="#tab-1">Folder</a></li>
<h:panelGroup rendered="#{folderBean.showFiles}">
    <li><a href="#tab-2">Files</a></li>
</h:panelGroup>
<h:panelGroup rendered="#{folderBean.showChildren}">
    <li><a href="#tab-3">Subfolders</a></li>
</h:panelGroup>
</ul>

<div id="tab-1">

<div class="form-row">
    <label>Title</label>
    <h:inputText value="#{folderBean.current.title}" styleClass="form-title"
        onchange="onTitleChange()" />
</div>
<div class="form-row">
    <label>Name for URL</label>
    <h:inputText value="#{folderBean.current.name}" styleClass="form-url"/>
</div>
<div class="buttons">
    <h:commandButton value="Save" action="#{folderBean.update}" />
    <h:commandButton value="Cancel" action="#{folderBean.cancelEdit}" />
    <h:commandButton value="Export" action="#{folderBean.export}" />
</div>    

</div>

<h:panelGroup rendered="#{folderBean.showFiles}">
<div id="tab-2">
    <div id="filesTable"> </div>
    <div class="buttons">
        <input type="button" value="Create file" onclick="onCreateFile()" />
        <input type="button" onclick="onUpload()" value="Upload file" />
        <input type="button" onclick="onDeleteFiles()" value="Delete files" />
        <h:commandButton value="Cancel" action="#{folderBean.cancelEdit}" />
    </div>
</div>
</h:panelGroup>

<h:panelGroup rendered="#{folderBean.showChildren}">
<div id="tab-3">

<h:dataTable value="#{folderBean.children}" var="r"
    styleClass="form-table">
    <h:column>
        <f:facet name="header"></f:facet>    
        <h:selectBooleanCheckbox value="#{folderBean.selected[r.id]}"/>
    </h:column>
    <h:column>
        <f:facet name="header" >Title</f:facet>    
        <a href="/cms/folder/edit/#{r.id}"><h:outputText value="#{r.title}"/></a>
    </h:column>
    <h:column>
        <f:facet name="header" >Name</f:facet>    
        <h:outputText value="#{r.name}"/>
    </h:column>
</h:dataTable>
<div class="buttons">
    <h:commandButton value="Add child folder" action="#{folderBean.addChild}" />
    <h:commandButton value="Delete folders" action="#{folderBean.delete}" />
    <h:commandButton value="Cancel" action="#{folderBean.cancelEdit}" />
</div>    

</div>
</h:panelGroup>

</div>

</h:form>

<div id="file-upload" title="Upload file to folder" style="display:none">
<form id="upload" action="/cms/upload" method="post" enctype="multipart/form-data">
    File upload:
    <input type="hidden" name="fileType" value="resource" />
    <input type="hidden" name="folderId" value="#{folderBean.current.id}" />
    <input type="file" name="uploadFile" />
    <div class="buttons-dlg">
        <input type="submit" value="Send" />
        <input type="button" onclick="onFileUploadCancel()" value="Cancel" />
    </div>
</form>
</div>


</ui:define>

</ui:composition>
